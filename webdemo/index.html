<!--
  Copyright 2025 FBK

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéôÔ∏è simulstream Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="logo.png">
</head>
<body>

  <div class="navbar">
    <div class="logo">
      <span class="name">SimulStream</span>
      <img src="logo.png" alt="Logo">
    </div>
  </div>

  <div class="input-data container">
    <div class="inputs">
      <div class="language-selectors">
        <div class="language-selector">
          <label for="src_language">Source Language</label>
          <select id="src_language">
          </select>
        </div>
        <div class="flow-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>
            </svg>
        </div>
        <div class="language-selector">
          <label for="tgt_language">Target Language</label>
          <select id="tgt_language">
          </select>
        </div>
      </div>
      <div class="controls">
        <button id="startBtn">Start Recording</button>
        <button id="stopBtn" disabled>Stop Recording</button>
      </div>
    </div>
    <canvas id="visualizer"></canvas>
  </div>

  <div class="output-data container">
    <p id="status"><span class="pulse red"></span>Status: Idle</p>
    <div id="transcript-text"></div>
  </div>

  <div id="credits" class="footer">
    <span>Powered by <strong id="credits_model_name"></strong></span>
  </div>

  <script type="module">
    import {SimulStreamClient} from "./simulstream_client.js";

    async function loadConfig(url) {
      try {
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const yamlText = await response.text();
        const data = jsyaml.load(yamlText);

        console.log("Parsed YAML:", data);
        return data;
      } catch (error) {
        console.error("Error loading YAML:", error);
      }
    }

    // Example usage
    const configLoader = loadConfig('/config.yaml');
    let simulstreamClient = null;

    let analyser;
    let dataArray;
    let animationId;

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('status');

    configLoader.then(function (config_yaml) {
      const config = config_yaml.webui
      if (config.tgt_supported_langs) {
        const langSelect = document.getElementById('tgt_language');
        for (var i = 0; i < config.tgt_supported_langs.length; ++i) {
          Object.entries(config.tgt_supported_langs[i]).forEach(([langId, langText]) => {
            const langOpt = document.createElement('option');
            langOpt.value = langId;
            langOpt.text = langText;
            langSelect.append(langOpt);
          });
        }
      }
      if (config.src_supported_langs) {
        const langSelect = document.getElementById('src_language');
        for (var i = 0; i < config.src_supported_langs.length; ++i) {
          Object.entries(config.src_supported_langs[i]).forEach(([langId, langText]) => {
            const langOpt = document.createElement('option');
            langOpt.value = langId;
            langOpt.text = langText;
            langSelect.append(langOpt);
          });
        }
      }
      const credits = document.getElementById('credits');
      if (config.model_name) {
        document.getElementById('credits_model_name').textContent = config.model_name;
        if (config.model_logo) {
          const logoImg = document.createElement('img');
          logoImg.src = config.model_logo;
          logoImg.className = 'footer-logo';
          logoImg.alt = config.model_name + ' logo';
          credits.prepend(logoImg);
        }
      }
    });

    function updateStatus(text, color = 'red') {
      statusText.textContent = '';
      const pulse = document.createElement('span');
      pulse.className = `pulse ${color}`;
      statusText.appendChild(pulse);
      statusText.append(` ${text}`);
    }

    function drawVisualizer() {
      if (!analyser) return;
      animationId = requestAnimationFrame(drawVisualizer);

      analyser.getByteTimeDomainData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#a78bfa';
      ctx.beginPath();

      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;

      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);

        x += sliceWidth;
      }

      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
    }

    startBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) {
        alert("Your browser doesn't support audio recording.");
        return;
      }

      try {

        if (simulstreamClient && simulstreamClient.socketOpen()) {
          simulstreamClient.closeSocket();
          const transcriptText = document.getElementById('transcript-text');
          transcriptText.textContent = '';
        }

        // WebSocket Setup
        const websocker_url = await configLoader.then(function (config) {
          const secure = config.secure ? 's' : '';
          return 'ws' + secure + '://' + config.hostname + ':' + config.port;
        });
        simulstreamClient = new SimulStreamClient(websocker_url)

        simulstreamClient.onopen = () => {
          updateStatus("Connected & Recording...", 'green');
        };
        simulstreamClient.onerror = () => {
          updateStatus("WebSocket error.", 'red');
        };
        simulstreamClient.onservermessage = (serverMessage) => {
          const transcriptText = document.getElementById('transcript-text');
          const charToDelete = serverMessage.deleted.length;
          const newTranscriptLen = transcriptText.textContent.length - charToDelete;
          transcriptText.textContent = transcriptText.textContent.substring(0, newTranscriptLen);
          transcriptText.textContent += serverMessage.new;

          // Auto-scroll to bottom
          transcriptText.scrollTop = transcriptText.scrollHeight;
        };

        let tgt_lang = document.getElementById("tgt_language").value;
        let src_lang = document.getElementById("src_language").value;

        await simulstreamClient.start(tgt_lang, src_lang)

        // Visualizer Setup
        analyser = simulstreamClient.audioContext.createAnalyser();
        analyser.fftSize = 2048;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        let source = simulstreamClient.audioContext.createMediaStreamSource(simulstreamClient.stream);
        source.connect(analyser);
        drawVisualizer();

        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error("Error:", err);
        updateStatus("Error accessing microphone.", 'red');
      }
    });

    stopBtn.addEventListener('click', () => {
      if (simulstreamClient) simulstreamClient.stop();
      updateStatus("Stopped.", 'red');
      cancelAnimationFrame(animationId);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    // Resize canvas to match display size
    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>
